@testable import NESKit
import XCTest

let snakeGame: [UInt8] = [
    0x20, 0x06, 0x06, 0x20, 0x38, 0x06, 0x20, 0x0D, 0x06, 0x20, 0x2A, 0x06, 0x60, 0xA9, 0x02, 0x85,
    0x02, 0xA9, 0x04, 0x85, 0x03, 0xA9, 0x11, 0x85, 0x10, 0xA9, 0x10, 0x85, 0x12, 0xA9, 0x0F, 0x85,
    0x14, 0xA9, 0x04, 0x85, 0x11, 0x85, 0x13, 0x85, 0x15, 0x60, 0xA5, 0xFE, 0x85, 0x00, 0xA5, 0xFE,
    0x29, 0x03, 0x18, 0x69, 0x02, 0x85, 0x01, 0x60, 0x20, 0x4D, 0x06, 0x20, 0x8D, 0x06, 0x20, 0xC3,
    0x06, 0x20, 0x19, 0x07, 0x20, 0x20, 0x07, 0x20, 0x2D, 0x07, 0x4C, 0x38, 0x06, 0xA5, 0xFF, 0xC9,
    0x77, 0xF0, 0x0D, 0xC9, 0x64, 0xF0, 0x14, 0xC9, 0x73, 0xF0, 0x1B, 0xC9, 0x61, 0xF0, 0x22, 0x60,
    0xA9, 0x04, 0x24, 0x02, 0xD0, 0x26, 0xA9, 0x01, 0x85, 0x02, 0x60, 0xA9, 0x08, 0x24, 0x02, 0xD0,
    0x1B, 0xA9, 0x02, 0x85, 0x02, 0x60, 0xA9, 0x01, 0x24, 0x02, 0xD0, 0x10, 0xA9, 0x04, 0x85, 0x02,
    0x60, 0xA9, 0x02, 0x24, 0x02, 0xD0, 0x05, 0xA9, 0x08, 0x85, 0x02, 0x60, 0x60, 0x20, 0x94, 0x06,
    0x20, 0xA8, 0x06, 0x60, 0xA5, 0x00, 0xC5, 0x10, 0xD0, 0x0D, 0xA5, 0x01, 0xC5, 0x11, 0xD0, 0x07,
    0xE6, 0x03, 0xE6, 0x03, 0x20, 0x2A, 0x06, 0x60, 0xA2, 0x02, 0xB5, 0x10, 0xC5, 0x10, 0xD0, 0x06,
    0xB5, 0x11, 0xC5, 0x11, 0xF0, 0x09, 0xE8, 0xE8, 0xE4, 0x03, 0xF0, 0x06, 0x4C, 0xAA, 0x06, 0x4C,
    0x35, 0x07, 0x60, 0xA6, 0x03, 0xCA, 0x8A, 0xB5, 0x10, 0x95, 0x12, 0xCA, 0x10, 0xF9, 0xA5, 0x02,
    0x4A, 0xB0, 0x09, 0x4A, 0xB0, 0x19, 0x4A, 0xB0, 0x1F, 0x4A, 0xB0, 0x2F, 0xA5, 0x10, 0x38, 0xE9,
    0x20, 0x85, 0x10, 0x90, 0x01, 0x60, 0xC6, 0x11, 0xA9, 0x01, 0xC5, 0x11, 0xF0, 0x28, 0x60, 0xE6,
    0x10, 0xA9, 0x1F, 0x24, 0x10, 0xF0, 0x1F, 0x60, 0xA5, 0x10, 0x18, 0x69, 0x20, 0x85, 0x10, 0xB0,
    0x01, 0x60, 0xE6, 0x11, 0xA9, 0x06, 0xC5, 0x11, 0xF0, 0x0C, 0x60, 0xC6, 0x10, 0xA5, 0x10, 0x29,
    0x1F, 0xC9, 0x1F, 0xF0, 0x01, 0x60, 0x4C, 0x35, 0x07, 0xA0, 0x00, 0xA5, 0xFE, 0x91, 0x00, 0x60,
    0xA6, 0x03, 0xA9, 0x00, 0x81, 0x10, 0xA2, 0x00, 0xA9, 0x01, 0x81, 0x10, 0x60, 0xA2, 0x00, 0xEA,
    0xEA, 0xCA, 0xD0, 0xFB, 0x60,
]

let asm = """
main:
  jsr init
  jsr loop
init:
  jsr initSnake
  jsr generateApplePosition
  rts
initSnake:
  lda #2
  sta 0x02
  lda #4
  sta 0x03
  lda #0x11
  sta 0x10
  lda #0x10
  sta 0x12
  lda #0x0f
  sta 0x14
  lda #0x04
  sta 0x11
  sta 0x13
  sta 0x15
  rts
generateApplePosition:
  lda 0xfe
  sta 0x00
  lda 0xfe
  and #0x03
  clc
  adc #2
  sta 0x01
  rts
loop:
  jsr readKeys
  jsr checkCollision
  jsr updateSnake
  jsr drawApple
  jsr drawSnake
  jsr spinWheels
  jmp loop
readKeys:
  lda 0xff
  cmp #0x77
  beq upKey
  cmp #0x64
  beq rightKey
  cmp #0x73
  beq downKey
  cmp #0x61
  beq leftKey
  rts
upKey:
  lda #4
  bit 0x02
  bne illegalMove
  lda #1
  sta 0x02
  rts
rightKey:
  lda #8
  bit 0x02
  bne illegalMove
  lda #2
  sta 0x02
  rts
downKey:
  lda #1
  bit 0x02
  bne illegalMove
  lda #4
  sta 0x02
  rts
leftKey:
  lda #2
  bit 0x02
  bne illegalMove
  lda #8
  sta 0x02
  rts
illegalMove:
  rts
checkCollision:
  jsr checkAppleCollision
  jsr checkSnakeCollision
  rts
checkAppleCollision:
  lda 0x00
  cmp 0x10
  bne doneCheckingAppleCollision
  lda 0x01
  cmp 0x11
  bne doneCheckingAppleCollision
  inc 0x03
  inc 0x03
  jsr generateApplePosition
doneCheckingAppleCollision:
  rts
checkSnakeCollision:
  ldx #2
snakeCollisionLoop:
  lda #(0x10,x)
  cmp 0x10
  bne continueCollisionLoop
maybeCollided:
  lda #(0x11, x)
  cmp 0x11
  beq didCollide
continueCollisionLoop:
  inx
  inx
  cpx 0x03
  beq didntCollide
  jmp snakeCollisionLoop
didCollide:
  jmp gameOver
didntCollide:
  rts
updateSnake:
  ldx 0x03
  dex
  txa
updateloop:
  lda #(0x10, x)
  sta #(0x12, x)
  dex
  bpl updateloop
  lda 0x02
  lsr A
  bcs up
  lsr A
  bcs right
  lsr A
  bcs down
  lsr A
  bcs left
up:
  lda 0x10
  sec
  sbc #0x20
  sta 0x10
  bcc upup
  rts
upup:
  dec 0x11
  lda #0x1
  cmp 0x11
  beq collision
  rts
right:
  inc 0x10
  lda #0x1f
  bit 0x10
  beq collision
  rts
down: 
  lda 0x10
  clc
  adc #0x20
  sta 0x10
  bcs downdown
  rts
downdown:
  inc 0x11
  lda #0x6
  cmp 0x11
  beq collision
  rts
left:
  dec 0x10
  lda 0x10
  and #0x1f
  cmp #0x1f
  beq collision
  rts
collision:
  jmp gameOver
drawApple:
  ldy #0
  lda 0xfe
  sta (0x00, y)
  rts
drawSnake:
  ldx #0
  lda #1
  sta (0x10, x)
  ldx 0x03
  lda #0
  sta (0x10, x)
  rts
spinWheels:
  ldx #0
spinloop:
  nop
  nop
  dex
  bne spinloop
  rts
gameOver:
  brk
"""

final class CPUSnakeTest: XCTestCase {
    func testSnakeGame() throws {
        // var assembler = Assembler6502()
        // try assembler.lex(source: asm)
        // try assembler.parse()
        // try assembler.assemble()

        var cpu = CPU6502()

        // cpu.nodes = assembler.nodes
        // for line in asm.split(separator: "\n") {
        //     cpu.sourceLines.append(String(line))
        // }
        // print("Original:")
        // printHexDumpForBytes(bytes: snakeGame)
        // print("Assembled:")
        // printHexDumpForBytes(bytes: assembler.assembly!)

        cpu.load(program: snakeGame)

        var steps = 0

        cpu.reset()
        loop: while true {
            cpu[0xFE] = UInt8.random(in: 1 ..< 16)
            cpu[0xFF] = 0x77

            switch try cpu.step() {
            case .ok:
                steps += 1
            case .interrupt:
                steps += 1
                break loop
            }
        }
    }
}
